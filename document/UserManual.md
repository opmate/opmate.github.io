# OpMate 사용자 매뉴얼

---

## 사용자 (User)

### 사용자 역할

사용자는 다음과 같은 종류의 역할(Role)을 가질 수 있으며, 역할에 따라 수행 가능한 작업의 범위가 달라진다.

| 역할명 | 권한 레벨 | 역할                                                             |
| ------ | :-------: | ---------------------------------------------------------------- |
| 관리자 | 0         | 자동화도구시스템 자체의 운영을 위한 각종 설정 변경을 할 수 있다. |
| 검토자 | 1         | 작업자가 수행하는 작업에 대해 승인 권한을 갖는다.                |
| 작업자 | 2         | 태스크를 정의하고 실행하기 위한 각종 권한을 갖는다.              |
| 관람자 | 3         | 조회 위주의 작업만 가능하다.                                     |


관리자의 권한 레벨이 가장 높으며, 순서대로 낮은 레벨을 갖는다. 상위 권한 레벨은 하위 권한 레벨이 가능한 작업을 수행할 수 있다.

### 사용자 추가/활성화

사용자 추가 요청은 별도의 인증 과정없이 할 수 있다. 요청된 사용자 추가는 관리자가 별도로 활성화해야 사용이 가능하며, 활성화시 사용자의 역할을 지정한다.

추가 요청시 다음과 같은 정보를 필수로 입력 받는다.

> 아이디, 비밀번호, 이름, 휴대전화번호, 회사메일(쪽지가능)주소

### 사용자 수정/삭제/비활성화

사용자 정보는 자신 또는 관리자가 수정할 수 있다. 삭제나 비활성화는 관리자만 가능하다.


## 사용자 그룹 (User Group)

사용자 그룹은 여러명의 사용자가 모여있는 집합이다. 각종 작업시 다수 사용자를 지정할 때 편의를 위해 사용한다.

하나의 사용자는 동시에 여러개의 사용자 그룹에 소속될 수 있다.

### 사용자 그룹 생성

사용자 그룹의 생성은 작업자 이상의 권한을 가지고 있으면 가능하고, 생성한 사용자가 해당 그룹의 소유자(Owner)가 된다.

생성시 다음과 같은 정보를 필수로 입력 받는다.

> 그룹ID

### 사용자 그룹 수정/삭제

그룹의 각종 속성, 소속 사용자 등을 변경하거나 삭제하는 작업은 소유자만 가능하다.

또한, 소유자는 자신이 소유자인 사용자 그룹을 다른 사용자로 변경할 수 있다.

## 노드 (Node)

노드는 운영 관리의 대상이 되는 서버이며 에이전트가 설치되어 있는 것을 의미한다.

### 신규 노드 추가

노드는 별도로 추가 작업을 할 필요가 없이 에이전트가 설치된 후 처음 실행시 자동으로 등록된다.

에이전트는 설치시 고유의 GUID를 가지고 있으며, 설치 후 처음 실행시 마스터에게 에이전트 GUID와 노드 정보(hostname, IP 등)를 전송한다.

### 노드 활성화

신규로 추가된 노드는 기본적으로 비활성화 상태이다. 각종 작업(노드 그룹에 추가, 태스크에 추가 등)에 사용하기 위해서는 먼저 노드를 활성화해야 한다.

작업자 이상의 권한을 가지고 있는 사용자가 노드ID의 입력하면서 활성화할 수 있다.

노드ID는 일반적으로 호스트명을 입력하지만, 강제사항은 아니다.

활성화를 수행한 사용자는 해당 노드의 소유자가 된다.

### 노드 수정

소유자는 노드의 추가 정보(설명 등)를 수정할 수 있다.

또한, 소유자는 자신이 소유자인 노드를 다른 사용자로 변경할 수 있다.

### 노드 삭제/비활성화

노드는 관리자만이 삭제하거나 비활성화 할 수 있다. 

## 노드 그룹 (Node Group)

노드 그룹은 여러개의 노드가 모여있는 집합이다. 태스크를 정의할때 다수 노드를 쉽게 추가하기 위해 사용할 수 있으며, 공통 속성을 정의하기 위해 사용할 수 있다.

하나의 노드는 여러개의 노드 그룹에 소속될 수 있다.

### 노드 그룹 생성

노드 그룹의 생성은 관리자 권한을 가지고 있어야 한다.

생성시 다음과 같은 정보를 필수로 입력 받는다.

> 그룹ID

### 노드 그룹 수정/삭제

그룹의 각종 속성, 포함 노드 등을 변경하거나 삭제하는 작업은 역시 관리자만 가능하다.

###  노드 그룹 속성

그룹에 소속된 모든 노드에 공통적으로 적용할 속성을 정의한다.

예를 들어, 특정 그룹에 TOMCAT_HOME=/home/tomcat 와 같은 속성을 정의하면 소속된 모든 노드의 속성으로 동일하게 적용되며, 스크립트에 해당 속성의 치환 변수(@OPM_ATTR.속성명@)가 사용되었을 경우 정의된 값으로 치환된다.

```
#!/bin/sh

@OPM_ATTR.TOMCAT_HOME@/bin/startup.sh
```

```
#!/bin/sh

/home/tomcat/bin/startup.sh
```

## 태스크 (Task)

태스크는 하나 이상의 노드를 대상으로 동일한 작업(스크립트)을 동시에 실행하기 위한 작업 정의서이다. 

### 태스크 정의


태스크의 생성은 작업자 이상의 권한을 가지고 있으면 가능하고, 생성한 사용자가 해당 태스크의 소유자(Owner)가 된다.

태스크 정의를  변경하거나 삭제하는 작업은 소유자만 가능하다. 또한, 소유자는 자신이 소유자인 태스크를 다른 사용자로 변경할 수 있다.

태스크의 주요 구성 정보는 다음과 같다.

> 대상 노드, 스크립트, 스케쥴, 실행 권한, 다음 태스크

#### 대상 노드 (Target Node)

태스크가 실행되기 원하는 대상 노드를 지정한다.  노드 또는 노드그룹으로 추가할 수 있다.

단, 관리의 혼란을 막기 위해 중복되는 노드가 존재할 경우에는 추가가 되지 않는다.

#### 스크립트 (Script)

스크립트는 실행할 쉘스크립트 파일과 해당 스크립트를 실행할 OS 유저를 지정한다.

#### 스케쥴 (Schedule)

태스크가 자동으로 실행될 시점을 정의한다. 다음과 같이 옵션에 따른 값을 지정할 수 있다.

| 옵션 | 지정값                      | 비고              |
| ---- | --------------------------- | ----------------- |
| 매시 | mm분                        | mm : 00 ~ 59      |
| 매일 | hh시 mm분                   | hh : 00 ~ 23      |
| 매주 | d요일 hh시 mm분             | d : 0(일) ~ 6(토) |
| 매월 | DD일 hh시 mm분              | DD : 01 ~ 31      |
| 매년 | MM월 DD일 hh시 mm분         | MM : 01 ~ 12      |
| 한번 | YYYY년 MM월 DD일 hh시 mm분  | YYYY : 2000~9999  |


> 스케쥴은 필수 사항이 아니다. 예를 들어, 온디맨드 방식으로만 실행하는 경우에는 등록할 필요가 없다.

#### 실행 권한 (Authority)

태스크가 실행 되는 방식은 다음 3가지이며, 각각 활성화(enable)/비활성화(disable) 할 수 있다.

> By 스케쥴러(Scheduler), By 온디맨드(On-Demand), By 태스크(Task)

"By 스케쥴러"가 비활성화된 경우 스케쥴에 시점이 등록되어 있더라도 실행되지 않는다.

"By 온디맨드"는 사용자가 직접 명령하여 바로 실행하는 방식으로, 활성화 된 경우 기본적으로 소유자는 실행이 가능하며, 추가로 실행 가능 사용자(작업자 이상)들을 등록할 수 있다.

"By 태스크"는 다른 태스크가 다음 태스크로 지정한 경우에 실행되는 방식이다. 이 경우 호출되는 태스크는 "By 태스크" 활성화하고 자신을 호출할 수 있는 태스크를 등록해야 한다.

#### 다음 태스크 (Next Task)

현 태스크의 실행이 완료된 후 자동으로 다른 태스크를 실행시킬 경우에 지정한다.

단, 호출되는 태스크에서는 현 태스크가 호출할 수 있도록 실행 권한을 부여해줘야 한다.

(예: A태스크와 B태스크가 C태스크를 Next Task로 지정하기 위해서는,  A와 B 태스크가 실행 가능하다는 것을 C태스크에서 권한설정을 해줘야 한다.)

#### 태스크의 승인과 리비젼(Revision)

신규로 추가되거나, 변경된 태스크는 작업본 상태로만 존재하고, 실제로 실행되기 위해서는 승인 과정을 거쳐야 한다. 승인은 태스크의 소유자가 검토자 권한을 가진 사용자에게 요청한다.

검토자에 의해 승인된 태스크는 리비젼 번호가 갱신된다. 리비젼 번호는 1부터 시작하며 승인시마다 1씩 증가한다.

리비젼 단위의 목록으로 태스크의 history를 조회할 수 있으며, 특정 리비젼 시점으로 복원도 가능하다.

### 태스크 실행

#### 실행 인스턴스 (Instance)

태스크가 실행되면 실행 인스턴스가 생성되며 실행 인스턴스의 상태를 확인 할 수 있다.

실행 인스턴스는 인스턴스 번호를 가지고 있으며 1부터 시작하며 실행시마다 1씩 증가한다.

태스크명을 지정하여 실행 인스턴스를 확인 할 경우 최신 인스턴스의 정보를 볼 수 있으며, 숫자를 지정하여 일정 개수의 최신 인스턴스 목록을 볼 수도 있다.

실행 인스턴스 조회시 노드별로 진행 상태와 실행 결과를 확인할 수 있으며, 다음과 같은 의미를 갖는다.

- 진행 상태
  - 준비 : 노드에 아직 실행 요청을 보내기 전 상태
  - 요청(실행중) : 노드에 실행 요청을 보낸 상태
  - 완료 : 노드가 쉘 스크립트를 수행하고 실행 결과를 회신한 상태
  - 실패 : 에이전트와 연결되지 못해 요청을 보내지 못했다거나, 기타의 이유(스크립트 다운 불가 등)로 쉘 스크립트를 실행하지 못한 경우
- 실행 결과
  - N/A
  - 성공 : 쉘 스크립트의 실행 결과 코드가 0 인 경우
  - 실패 : 진행 상태가 실패이거나, 쉘 스크립트의 실행 결과 코드가 0 이 아닌 경우
- 실행 결과 코드 : 쉘스크립의 최종 리턴값

또한, 노드별로 상세 조회시 쉘스크립트의 표준출력과 표준에러 결과를 확인해 볼 수 있다.

#### 재실행

이미 생성된 실행 인스턴스는 특정 노드를 지정하여 노드 단위로 재실행할 수 있다.

해당 노드의 진행 상태가 완료 또는 실패인 경우에만 가능하다.

> 실행 인스턴스의 생성 시점 이후에 해당 태스크의 리비젼이 변경되었을 경우 재실행은 불가하다.

## 파일 배포/수집 유틸리티

노드별 에이전트와 함께 설치되는 유틸리티이며, 쉘스크립트에 기술하여 실행할 수 있다.

즉, 마스터 서버가 아닌 노드 입장에서 마스터로 업로드하거나, 마스터에서 다운로드하는 방식이다.

마스터에 저장된 파일은 일정 기간이 지나면 자동으로 삭제된다. 마스터의 파일 리파지토리는 보관을 목적으로 하는 것이 아닌, 대량의 파일 수집과 배포를 위해 사용하는 임시 공간으로 사용하도록 한다.


### 파일 배포

마스터 서버에 존재하는 파일을 노드에 배포할 경우에 사용한다. 

다음 예제는, 마스터 서버 리파지토리의 /mydir/install-tomcat-1.0.tar.gz 파일을 받아와 노드의 /home/was/install-tomcat-1.0.tar.gz 에 저장하는 명령이다.

```
$ opmfget master:/mydir/install-tomcat-1.0.tar.gz /home/was/install-tomcat-1.0.tar.gz
```

### 파일 수집

노드에 존재하는 파일을 마스터 서버로 전송할 경우 사용한다.

다음 예제는,  노드의 /home/was/tomcat-1.0/conf/server.xml 파일을 마스터 서버 리파지토리의 /mydir/node1/server.xml 에 저장하는 명령이다.

```
$ opmfput master:/mydir/node1/server.xml /home/scott/server.xml
```

